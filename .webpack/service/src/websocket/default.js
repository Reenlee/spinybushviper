!function(e,n){for(var t in n)e[t]=n[t]}(exports,function(e){var n={};function t(r){if(n[r])return n[r].exports;var u=n[r]={i:r,l:!1,exports:{}};return e[r].call(u.exports,u,u.exports,t),u.l=!0,u.exports}return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var u in e)t.d(r,u,function(n){return e[n]}.bind(null,u));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=28)}([function(e,n){e.exports=require("babel-runtime/regenerator")},function(e,n){e.exports=require("babel-runtime/helpers/asyncToGenerator")},function(e,n){e.exports=require("babel-runtime/core-js/json/stringify")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.COLLECTIONS={USER:"users",CHAT:"chats",ROOM:"rooms",INVITE:"invites"}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Entity=void 0;var r=t(5);n.Entity=function(e){return{collection:function(){return e},create:function(n){return(0,r.insertOneAsync)(e,n)},createMany:function(n){var t=n.map((function(e){return e}));return(0,r.insertManyAsync)(e,t)},upsert:function(n,t){return(0,r.upsertOneAsync)(e,n,t)},update:function(n,t){return(0,r.updateOneAsync)(e,n,t)},updateMany:function(n,t){return(0,r.updateManyAsync)(e,n,t)},find:function(n){return(0,r.findOneAsync)(e,n)},list:function(n,t,u){return(0,r.listManyAsync)(e,n,t,u)},listIn:function(n,t,u,a,s){return(0,r.listManyInAsync)(e,n,t,u,a,s)},listOr:function(n,t,u,a){return(0,r.listManyOrAsync)(e,n,t,u,a)},delete:function(n){return(0,r.deleteOneAsync)(e,n)},push:function(n,t){return(0,r.pushItemsAsync)(e,n,t)},pull:function(n,t){return(0,r.pullItemsAsync)(e,n,t)}}}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.deleteOneAsync=n.updateManyAsync=n.pullItemsAsync=n.pushItemsAsync=n.upsertOneAsync=n.updateOneAsync=n.insertManyAsync=n.insertOneAsync=n.listManyOrAsync=n.listManyInAsync=n.listManyAsync=n.findOneAsync=void 0;var r=i(t(6)),u=i(t(7)),a=i(t(0)),s=i(t(1)),c=t(8);function i(e){return e&&e.__esModule?e:{default:e}}var o,f,d,l,p,y,v,b,O,x,A,m;n.findOneAsync=(o=(0,s.default)(a.default.mark((function e(n,t,r){var u;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.connectDB)(n);case 2:return u=e.sent,e.abrupt("return",u.findOne(t,r));case 4:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return o.apply(this,arguments)}),n.listManyAsync=(f=(0,s.default)(a.default.mark((function e(n,t,r,u){var s;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.connectDB)(n);case 2:return s=e.sent,e.abrupt("return",s.find(t).sort(r).project(u).toArray());case 4:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t,r){return f.apply(this,arguments)}),n.listManyInAsync=(d=(0,s.default)(a.default.mark((function e(n,t,s){var i,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},f=arguments[4],d=arguments[5];return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.connectDB)(n);case 2:return i=e.sent,e.abrupt("return",i.find((0,u.default)((0,r.default)({},t,{$in:s}),o)).sort(f).project(d).toArray());case 4:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return d.apply(this,arguments)}),n.listManyOrAsync=(l=(0,s.default)(a.default.mark((function e(n,t,r,s,i){var o;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.connectDB)(n);case 2:return o=e.sent,e.abrupt("return",o.find((0,u.default)({$or:t},r)).sort(s).project(i).toArray());case 4:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t,r,u){return l.apply(this,arguments)}),n.insertOneAsync=(p=(0,s.default)(a.default.mark((function e(n,t){var r;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.connectDB)(n);case 2:return r=e.sent,e.next=5,r.insertOne(t);case 5:return e.abrupt("return",e.sent.ops[0]);case 6:case"end":return e.stop()}}),e,void 0)}))),function(e,n){return p.apply(this,arguments)}),n.insertManyAsync=(y=(0,s.default)(a.default.mark((function e(n,t){var r;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.connectDB)(n);case 2:return r=e.sent,e.next=5,r.insertMany(t);case 5:return e.abrupt("return",e.sent.ops);case 6:case"end":return e.stop()}}),e,void 0)}))),function(e,n){return y.apply(this,arguments)}),n.updateOneAsync=(v=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,i;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.connectDB)(n);case 2:return u=e.sent,e.next=5,u.findOneAndUpdate(t,{$set:r},{returnOriginal:!1});case 5:return s=e.sent,i=s.value,e.abrupt("return",i);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return v.apply(this,arguments)}),n.upsertOneAsync=(b=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,i;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.connectDB)(n);case 2:return u=e.sent,e.next=5,u.findOneAndUpdate(t,{$set:r},{returnOriginal:!1,upsert:!0});case 5:return s=e.sent,i=s.value,e.abrupt("return",i);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return b.apply(this,arguments)}),n.pushItemsAsync=(O=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,i;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.connectDB)(n);case 2:return u=e.sent,e.next=5,u.findOneAndUpdate(t,{$push:r},{returnOriginal:!1});case 5:return s=e.sent,i=s.value,e.abrupt("return",i);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return O.apply(this,arguments)}),n.pullItemsAsync=(x=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,i;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.connectDB)(n);case 2:return u=e.sent,e.next=5,u.findOneAndUpdate(t,{$pull:r},{returnOriginal:!1});case 5:return s=e.sent,i=s.value,e.abrupt("return",i);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return x.apply(this,arguments)}),n.updateManyAsync=(A=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,i;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.connectDB)(n);case 2:return u=e.sent,e.next=5,u.updateMany(t,{$set:r});case 5:return s=e.sent,i=s.value,e.abrupt("return",i);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return A.apply(this,arguments)}),n.deleteOneAsync=(m=(0,s.default)(a.default.mark((function e(n,t){var r,u,s;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.connectDB)(n);case 2:return r=e.sent,e.next=5,r.findOneAndUpdate(t,{$set:{active:!1}},{returnOriginal:!1});case 5:return u=e.sent,s=u.value,e.abrupt("return",s);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n){return m.apply(this,arguments)})},function(e,n){e.exports=require("babel-runtime/helpers/defineProperty")},function(e,n){e.exports=require("babel-runtime/helpers/extends")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.connectDB=void 0;var r,u=c(t(0)),a=c(t(1)),s=(n.connectDB=(r=(0,a.default)(u.default.mark((function e(n){var t,r,a,c;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=process.env.MDB_USERNAME,r=process.env.MDB_PASSWORD,a=process.env.MDB_DATABASE,console.log(t,r,a),void 0!==global.client){e.next=10;break}return console.log("client is undefined. connecting again."),c="mongodb+srv://"+t+":"+r+"@cluster0-sb1ds.mongodb.net/"+a+"?retryWrites=true&w=majority",global.client=new s.MongoClient(c,{useNewUrlParser:!0,useUnifiedTopology:!0}),e.next=10,global.client.connect();case 10:return e.abrupt("return",global.client.db(a).collection(n));case 11:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)}),t(9));function c(e){return e&&e.__esModule?e:{default:e}}},function(e,n){e.exports=require("mongodb")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.encode=function(e){return r.sign(e,u.JWT_PASSWORD)},n.verifyHeader=function(e){var n=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=e.split(" ");if(2===n.length){var t=n[0],a=n[1];if(/^Bearer$/i.test(t))return r.verify(a,u.JWT_PASSWORD)}throw new Error}(e.Authorization);return delete global.auth,global.auth=n,n};var r=function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n.default=e,n}(t(11)),u=t(12)},function(e,n){e.exports=require("jsonwebtoken")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.JWT_PASSWORD="Password1234"},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(3),u=t(4),a=r.COLLECTIONS.USER,s=(0,u.Entity)(a);n.default=s},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(3),u=t(4),a=r.COLLECTIONS.ROOM,s=(0,u.Entity)(a);n.default=s},function(e,n){e.exports=require("uuid")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(3),u=t(4),a=r.COLLECTIONS.INVITE,s=(0,u.Entity)(a);n.default=s},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(3),u=t(4),a=r.COLLECTIONS.CHAT,s=(0,u.Entity)(a);n.default=s},,,,,,,,,,,function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.handler=void 0;var r=v(t(29)),u=v(t(0)),a=v(t(1)),s=v(t(2)),c=v(t(30)),i=function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n.default=e,n}(t(31)),o=v(t(15)),f=t(10),d=v(t(13)),l=v(t(17)),p=v(t(14)),y=v(t(16));function v(e){return e&&e.__esModule?e:{default:e}}var b,O=function(e,n,t){return new c.default((function(r,c){var i;e.postToConnection({ConnectionId:n,Data:(0,s.default)(t)},(i=(0,a.default)(u.default.mark((function e(t,a){var s;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=7;break}return e.next=3,d.default.find({connections:n});case 3:return s=e.sent,e.next=6,d.default.pull({id:s.id},{connections:n});case 6:c(t);case 7:r(a);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n){return i.apply(this,arguments)}))}))};n.handler=(b=(0,a.default)(u.default.mark((function e(n){var t,a,v,b,x,A,m,h,w,M,_,g,I,j,k,D,P,S,C,T;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=n.requestContext,a=n.body,v=t.connectionId,b=t.domainName,x=t.stage,A=JSON.parse(a),m=A.data,e.next=6,(0,f.verifyHeader)({Authorization:m.auth_token});case 6:if(h=e.sent,"connect"!==m.type){e.next=10;break}return e.next=10,d.default.push({id:h.userId},{connections:v});case 10:if("send"!==m.type){e.next=31;break}if(w=new i.ApiGatewayManagementApi({apiVersion:"2018-11-29",endpoint:"https://"+b+"/"+x}),M={id:o.default.v4(),type:m.type,createdOn:(new Date).getTime(),senderId:m.senderId,recipientId:m.recipientId,roomId:m.roomId,message:m.message,active:!0},!m.recipientId){e.next=19;break}return e.next=16,d.default.find({id:m.recipientId});case 16:return _=e.sent,e.next=19,c.default.all(_.connections.map((function(e){return O(w,e,M)})));case 19:if(!m.roomId){e.next=29;break}return e.next=22,p.default.find({id:m.roomId});case 22:return I=e.sent,j=I.userIds,k=void 0===j?[]:j,e.next=26,d.default.listIn("id",k);case 26:return D=e.sent,e.next=29,c.default.all((g=[]).concat.apply(g,(0,r.default)(D.map((function(e){return e.connections})))).filter((function(e){return e!==v})).map((function(e){return O(w,e,M)})));case 29:return e.next=31,l.default.create(M);case 31:if("invite"!==m.type){e.next=42;break}return P=new i.ApiGatewayManagementApi({apiVersion:"2018-11-29",endpoint:"https://"+b+"/"+x}),e.next=35,d.default.find({username:m.username});case 35:return S=e.sent,C=S.connections,T={id:o.default.v4(),type:m.type,createdOn:(new Date).getTime(),username:h.username,senderId:h.userId,recipientId:S.id,active:!0},e.next=40,y.default.create(T);case 40:return e.next=42,c.default.all(C.map((function(e){return O(P,e,T)})));case 42:return e.abrupt("return",{statusCode:200,headers:{"Access-Control-Allow-Origin":"*"},body:(0,s.default)({})});case 45:return e.prev=45,e.t0=e.catch(0),console.log(e.t0),e.abrupt("return",{statusCode:500,headers:{"Access-Control-Allow-Origin":"*"},body:(0,s.default)(e.t0,["name","message"])});case 49:case"end":return e.stop()}}),e,void 0,[[0,45]])}))),function(e){return b.apply(this,arguments)})},function(e,n){e.exports=require("babel-runtime/helpers/toConsumableArray")},function(e,n){e.exports=require("babel-runtime/core-js/promise")},function(e,n){e.exports=require("aws-sdk")}]));