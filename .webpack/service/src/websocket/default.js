<<<<<<< HEAD
!function(e,n){for(var t in n)e[t]=n[t]}(exports,function(e){var n={};function t(r){if(n[r])return n[r].exports;var u=n[r]={i:r,l:!1,exports:{}};return e[r].call(u.exports,u,u.exports,t),u.l=!0,u.exports}return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var u in e)t.d(r,u,function(n){return e[n]}.bind(null,u));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=27)}([function(e,n){e.exports=require("babel-runtime/regenerator")},function(e,n){e.exports=require("babel-runtime/helpers/asyncToGenerator")},function(e,n){e.exports=require("babel-runtime/core-js/json/stringify")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.deleteOneAsync=n.updateManyAsync=n.pullItemsAsync=n.pushItemsAsync=n.upsertOneAsync=n.updateOneAsync=n.insertManyAsync=n.insertOneAsync=n.listManyOrAsync=n.listManyInAsync=n.listManyAsync=n.findOneAsync=void 0;var r=c(t(4)),u=c(t(5)),a=c(t(0)),s=c(t(1)),i=t(6);function c(e){return e&&e.__esModule?e:{default:e}}var o,d,f,l,p,y,v,x,b,m,O,A;n.findOneAsync=(o=(0,s.default)(a.default.mark((function e(n,t,r){var u;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return u=e.sent,e.abrupt("return",u.findOne(t,r));case 4:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return o.apply(this,arguments)}),n.listManyAsync=(d=(0,s.default)(a.default.mark((function e(n,t,r,u){var s;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return s=e.sent,e.abrupt("return",s.find(t).sort(r).project(u).toArray());case 4:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t,r){return d.apply(this,arguments)}),n.listManyInAsync=(f=(0,s.default)(a.default.mark((function e(n,t,s){var c,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},d=arguments[4],f=arguments[5];return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return c=e.sent,e.abrupt("return",c.find((0,u.default)((0,r.default)({},t,{$in:s}),o)).sort(d).project(f).toArray());case 4:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return f.apply(this,arguments)}),n.listManyOrAsync=(l=(0,s.default)(a.default.mark((function e(n,t,r,s,c){var o;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return o=e.sent,e.abrupt("return",o.find((0,u.default)({$or:t},r)).sort(s).project(c).toArray());case 4:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t,r,u){return l.apply(this,arguments)}),n.insertOneAsync=(p=(0,s.default)(a.default.mark((function e(n,t){var r;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return r=e.sent,e.next=5,r.insertOne(t);case 5:return e.abrupt("return",e.sent.ops[0]);case 6:case"end":return e.stop()}}),e,void 0)}))),function(e,n){return p.apply(this,arguments)}),n.insertManyAsync=(y=(0,s.default)(a.default.mark((function e(n,t){var r;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return r=e.sent,e.next=5,r.insertMany(t);case 5:return e.abrupt("return",e.sent.ops);case 6:case"end":return e.stop()}}),e,void 0)}))),function(e,n){return y.apply(this,arguments)}),n.updateOneAsync=(v=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,c;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return u=e.sent,e.next=5,u.findOneAndUpdate(t,{$set:r},{returnOriginal:!1});case 5:return s=e.sent,c=s.value,e.abrupt("return",c);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return v.apply(this,arguments)}),n.upsertOneAsync=(x=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,c;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return u=e.sent,e.next=5,u.findOneAndUpdate(t,{$set:r},{returnOriginal:!1,upsert:!0});case 5:return s=e.sent,c=s.value,e.abrupt("return",c);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return x.apply(this,arguments)}),n.pushItemsAsync=(b=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,c;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return u=e.sent,e.next=5,u.findOneAndUpdate(t,{$push:r},{returnOriginal:!1});case 5:return s=e.sent,c=s.value,e.abrupt("return",c);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return b.apply(this,arguments)}),n.pullItemsAsync=(m=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,c;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return u=e.sent,e.next=5,u.findOneAndUpdate(t,{$pull:r},{returnOriginal:!1});case 5:return s=e.sent,c=s.value,e.abrupt("return",c);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return m.apply(this,arguments)}),n.updateManyAsync=(O=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,c;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return u=e.sent,e.next=5,u.updateMany(t,{$set:r});case 5:return s=e.sent,c=s.value,e.abrupt("return",c);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return O.apply(this,arguments)}),n.deleteOneAsync=(A=(0,s.default)(a.default.mark((function e(n,t){var r,u,s;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return r=e.sent,e.next=5,r.findOneAndUpdate(t,{$set:{active:!1}},{returnOriginal:!1});case 5:return u=e.sent,s=u.value,e.abrupt("return",s);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n){return A.apply(this,arguments)})},function(e,n){e.exports=require("babel-runtime/helpers/defineProperty")},function(e,n){e.exports=require("babel-runtime/helpers/extends")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.connectDB=void 0;var r,u=i(t(0)),a=i(t(1)),s=(n.connectDB=(r=(0,a.default)(u.default.mark((function e(n){var t,r,a,i;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=process.env.MDB_USERNAME,r=process.env.MDB_PASSWORD,a=process.env.MDB_DATABASE,console.log(t,r,a),void 0!==global.client){e.next=10;break}return console.log("client is undefined. connecting again."),i="mongodb+srv://"+t+":"+r+"@cluster0-sb1ds.mongodb.net/"+a+"?retryWrites=true&w=majority",global.client=new s.MongoClient(i,{useNewUrlParser:!0,useUnifiedTopology:!0}),e.next=10,global.client.connect();case 10:return e.abrupt("return",global.client.db(a).collection(n));case 11:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)}),t(7));function i(e){return e&&e.__esModule?e:{default:e}}},function(e,n){e.exports=require("mongodb")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.COLLECTIONS={USER:"users",CHAT:"chats",ROOM:"rooms",INVITE:"invites"}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Entity=void 0;var r=t(3);n.Entity=function(e){return{collection:function(){return e},create:function(n){return(0,r.insertOneAsync)(e,n)},createMany:function(n){var t=n.map((function(e){return e}));return(0,r.insertManyAsync)(e,t)},upsert:function(n,t){return(0,r.upsertOneAsync)(e,n,t)},update:function(n,t){return(0,r.updateOneAsync)(e,n,t)},updateMany:function(n,t){return(0,r.updateManyAsync)(e,n,t)},find:function(n){return(0,r.findOneAsync)(e,n)},list:function(n,t,u){return(0,r.listManyAsync)(e,n,t,u)},listIn:function(n,t,u,a,s){return(0,r.listManyInAsync)(e,n,t,u,a,s)},listOr:function(n,t,u,a){return(0,r.listManyOrAsync)(e,n,t,u,a)},delete:function(n){return(0,r.deleteOneAsync)(e,n)},push:function(n,t){return(0,r.pushItemsAsync)(e,n,t)},pull:function(n,t){return(0,r.pullItemsAsync)(e,n,t)}}}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.encode=function(e){return r.sign(e,u.JWT_PASSWORD)},n.verifyHeader=function(e){var n=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=e.split(" ");if(2===n.length){var t=n[0],a=n[1];if(/^Bearer$/i.test(t))return r.verify(a,u.JWT_PASSWORD)}throw new Error}(e.Authorization);return delete global.auth,global.auth=n,n};var r=function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n.default=e,n}(t(11)),u=t(12)},function(e,n){e.exports=require("jsonwebtoken")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.JWT_PASSWORD="Password1234"},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(8),u=t(9),a=r.COLLECTIONS.USER,s=(0,u.Entity)(a);n.default=s},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(8),u=t(9),a=r.COLLECTIONS.INVITE,s=(0,u.Entity)(a);n.default=s},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(8),u=t(9),a=r.COLLECTIONS.ROOM,s=(0,u.Entity)(a);n.default=s},function(e,n){e.exports=require("uuid")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(8),u=t(9),a=r.COLLECTIONS.CHAT,s=(0,u.Entity)(a);n.default=s},,,,,,,,,,function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.handler=void 0;var r=v(t(28)),u=v(t(0)),a=v(t(1)),s=v(t(2)),i=v(t(29)),c=function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n.default=e,n}(t(30)),o=v(t(16)),d=t(10),f=v(t(13)),l=v(t(17)),p=v(t(15)),y=v(t(14));function v(e){return e&&e.__esModule?e:{default:e}}var x,b=function(e,n,t){return new i.default((function(r,i){var c;e.postToConnection({ConnectionId:n,Data:(0,s.default)(t)},(c=(0,a.default)(u.default.mark((function e(t,a){var s;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=7;break}return e.next=3,f.default.find({connections:n});case 3:return s=e.sent,e.next=6,f.default.pull({id:s.id},{connections:n});case 6:i(t);case 7:r(a);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n){return c.apply(this,arguments)}))}))};n.handler=(x=(0,a.default)(u.default.mark((function e(n){var t,a,v,x,m,O,A,h,w,M,I,g,_,j,k,D,P,S,C,T,B,E,q,N,L,U,R,$,W,V,G,H;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=n.requestContext,a=n.body,v=t.connectionId,x=t.domainName,m=t.stage,O=JSON.parse(a),A=O.data,e.next=6,(0,d.verifyHeader)({Authorization:A.auth_token});case 6:if(h=e.sent,"connect"!==A.type){e.next=10;break}return e.next=10,f.default.push({id:h.userId},{connections:v});case 10:if("send"!==A.type){e.next=31;break}if(w=new c.ApiGatewayManagementApi({apiVersion:"2018-11-29",endpoint:"https://"+x+"/"+m}),M={id:o.default.v4(),type:A.type,createdOn:(new Date).getTime(),senderId:A.senderId,recipientId:A.recipientId,roomId:A.roomId,message:A.message,active:!0},!A.recipientId){e.next=19;break}return e.next=16,f.default.find({id:A.recipientId});case 16:return I=e.sent,e.next=19,i.default.all(I.connections.map((function(e){return b(w,e,M)})));case 19:if(!A.roomId){e.next=29;break}return e.next=22,p.default.find({id:A.roomId});case 22:return _=e.sent,j=_.userIds,k=void 0===j?[]:j,e.next=26,f.default.listIn("id",k);case 26:return D=e.sent,e.next=29,i.default.all((g=[]).concat.apply(g,(0,r.default)(D.map((function(e){return e.connections||[]})))).filter((function(e){return e!==v})).map((function(e){return b(w,e,M)})));case 29:return e.next=31,l.default.create(M);case 31:if("invite"!==A.type){e.next=42;break}return P=new c.ApiGatewayManagementApi({apiVersion:"2018-11-29",endpoint:"https://"+x+"/"+m}),e.next=35,f.default.find({username:A.username});case 35:return S=e.sent,C=S.connections,T={id:o.default.v4(),type:A.type,createdOn:(new Date).getTime(),username:h.username,senderId:h.userId,recipientId:S.id,active:!0},e.next=40,y.default.create(T);case 40:return e.next=42,i.default.all(C.map((function(e){return b(P,e,T)})));case 42:if("accept"!==A.type){e.next=60;break}return B=new c.ApiGatewayManagementApi({apiVersion:"2018-11-29",endpoint:"https://"+x+"/"+m}),e.next=46,f.default.find({username:h.username});case 46:return E=e.sent,e.next=49,f.default.find({username:A.username});case 49:return q=e.sent,e.next=52,f.default.push({id:h.userId},{friends:q.id});case 52:return e.next=54,f.default.push({id:q.id},{friends:h.userId});case 54:return e.next=56,y.default.delete({senderId:q.id,recipientId:h.userId});case 56:return N=q.connections,L={type:A.type,friends:[q,{id:h.userId,username:h.username}]},e.next=60,i.default.all(E.connections.concat(N).map((function(e){return b(B,e,L)})));case 60:if("add-room"!==A.type){e.next=72;break}return R=new c.ApiGatewayManagementApi({apiVersion:"2018-11-29",endpoint:"https://"+x+"/"+m}),$=A.name,W=A.userIds,e.next=65,p.default.create({id:o.default.v4(),name:$,userIds:W.concat(h.userId)});case 65:return V=e.sent,e.next=68,f.default.listIn("id",W.concat(h.userId));case 68:return G=e.sent,H={type:A.type,room:V},e.next=72,i.default.all((U=[]).concat.apply(U,(0,r.default)(G.map((function(e){return e.connections||[]})))).map((function(e){return b(R,e,H)})));case 72:return e.abrupt("return",{statusCode:200,headers:{"Access-Control-Allow-Origin":"*"},body:(0,s.default)({})});case 75:return e.prev=75,e.t0=e.catch(0),console.log(e.t0),e.abrupt("return",{statusCode:500,headers:{"Access-Control-Allow-Origin":"*"},body:(0,s.default)(e.t0,["name","message"])});case 79:case"end":return e.stop()}}),e,void 0,[[0,75]])}))),function(e){return x.apply(this,arguments)})},function(e,n){e.exports=require("babel-runtime/helpers/toConsumableArray")},function(e,n){e.exports=require("babel-runtime/core-js/promise")},function(e,n){e.exports=require("aws-sdk")}]));
=======
!function(e,n){for(var t in n)e[t]=n[t]}(exports,function(e){var n={};function t(r){if(n[r])return n[r].exports;var u=n[r]={i:r,l:!1,exports:{}};return e[r].call(u.exports,u,u.exports,t),u.l=!0,u.exports}return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var u in e)t.d(r,u,function(n){return e[n]}.bind(null,u));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=29)}([function(e,n){e.exports=require("babel-runtime/regenerator")},function(e,n){e.exports=require("babel-runtime/helpers/asyncToGenerator")},function(e,n){e.exports=require("babel-runtime/core-js/json/stringify")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.deleteOneAsync=n.updateManyAsync=n.pullItemsAsync=n.pushItemsAsync=n.upsertOneAsync=n.updateOneAsync=n.insertManyAsync=n.insertOneAsync=n.listManyOrAsync=n.listManyInAsync=n.listManyAsync=n.findOneAsync=void 0;var r=c(t(4)),u=c(t(5)),a=c(t(0)),s=c(t(1)),i=t(6);function c(e){return e&&e.__esModule?e:{default:e}}var o,d,f,l,p,y,v,x,b,m,O,A;n.findOneAsync=(o=(0,s.default)(a.default.mark((function e(n,t,r){var u;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return u=e.sent,e.abrupt("return",u.findOne(t,r));case 4:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return o.apply(this,arguments)}),n.listManyAsync=(d=(0,s.default)(a.default.mark((function e(n,t,r,u){var s;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return s=e.sent,e.abrupt("return",s.find(t).sort(r).project(u).toArray());case 4:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t,r){return d.apply(this,arguments)}),n.listManyInAsync=(f=(0,s.default)(a.default.mark((function e(n,t,s){var c,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},d=arguments[4],f=arguments[5];return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return c=e.sent,e.abrupt("return",c.find((0,u.default)((0,r.default)({},t,{$in:s}),o)).sort(d).project(f).toArray());case 4:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return f.apply(this,arguments)}),n.listManyOrAsync=(l=(0,s.default)(a.default.mark((function e(n,t,r,s,c){var o;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return o=e.sent,e.abrupt("return",o.find((0,u.default)({$or:t},r)).sort(s).project(c).toArray());case 4:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t,r,u){return l.apply(this,arguments)}),n.insertOneAsync=(p=(0,s.default)(a.default.mark((function e(n,t){var r;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return r=e.sent,e.next=5,r.insertOne(t);case 5:return e.abrupt("return",e.sent.ops[0]);case 6:case"end":return e.stop()}}),e,void 0)}))),function(e,n){return p.apply(this,arguments)}),n.insertManyAsync=(y=(0,s.default)(a.default.mark((function e(n,t){var r;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return r=e.sent,e.next=5,r.insertMany(t);case 5:return e.abrupt("return",e.sent.ops);case 6:case"end":return e.stop()}}),e,void 0)}))),function(e,n){return y.apply(this,arguments)}),n.updateOneAsync=(v=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,c;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return u=e.sent,e.next=5,u.findOneAndUpdate(t,{$set:r},{returnOriginal:!1});case 5:return s=e.sent,c=s.value,e.abrupt("return",c);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return v.apply(this,arguments)}),n.upsertOneAsync=(x=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,c;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return u=e.sent,e.next=5,u.findOneAndUpdate(t,{$set:r},{returnOriginal:!1,upsert:!0});case 5:return s=e.sent,c=s.value,e.abrupt("return",c);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return x.apply(this,arguments)}),n.pushItemsAsync=(b=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,c;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return u=e.sent,e.next=5,u.findOneAndUpdate(t,{$push:r},{returnOriginal:!1});case 5:return s=e.sent,c=s.value,e.abrupt("return",c);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return b.apply(this,arguments)}),n.pullItemsAsync=(m=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,c;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return u=e.sent,e.next=5,u.findOneAndUpdate(t,{$pull:r},{returnOriginal:!1});case 5:return s=e.sent,c=s.value,e.abrupt("return",c);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return m.apply(this,arguments)}),n.updateManyAsync=(O=(0,s.default)(a.default.mark((function e(n,t,r){var u,s,c;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return u=e.sent,e.next=5,u.updateMany(t,{$set:r});case 5:return s=e.sent,c=s.value,e.abrupt("return",c);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n,t){return O.apply(this,arguments)}),n.deleteOneAsync=(A=(0,s.default)(a.default.mark((function e(n,t){var r,u,s;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.connectDB)(n);case 2:return r=e.sent,e.next=5,r.findOneAndUpdate(t,{$set:{active:!1}},{returnOriginal:!1});case 5:return u=e.sent,s=u.value,e.abrupt("return",s);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n){return A.apply(this,arguments)})},function(e,n){e.exports=require("babel-runtime/helpers/defineProperty")},function(e,n){e.exports=require("babel-runtime/helpers/extends")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.connectDB=void 0;var r,u=i(t(0)),a=i(t(1)),s=(n.connectDB=(r=(0,a.default)(u.default.mark((function e(n){var t,r,a,i;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=process.env.MDB_USERNAME,r=process.env.MDB_PASSWORD,a=process.env.MDB_DATABASE,console.log(t,r,a),void 0!==global.client){e.next=10;break}return console.log("client is undefined. connecting again."),i="mongodb+srv://"+t+":"+r+"@cluster0-sb1ds.mongodb.net/"+a+"?retryWrites=true&w=majority",global.client=new s.MongoClient(i,{useNewUrlParser:!0,useUnifiedTopology:!0}),e.next=10,global.client.connect();case 10:return e.abrupt("return",global.client.db(a).collection(n));case 11:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)}),t(7));function i(e){return e&&e.__esModule?e:{default:e}}},function(e,n){e.exports=require("mongodb")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.COLLECTIONS={USER:"users",CHAT:"chats",ROOM:"rooms",INVITE:"invites"}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Entity=void 0;var r=t(3);n.Entity=function(e){return{collection:function(){return e},create:function(n){return(0,r.insertOneAsync)(e,n)},createMany:function(n){var t=n.map((function(e){return e}));return(0,r.insertManyAsync)(e,t)},upsert:function(n,t){return(0,r.upsertOneAsync)(e,n,t)},update:function(n,t){return(0,r.updateOneAsync)(e,n,t)},updateMany:function(n,t){return(0,r.updateManyAsync)(e,n,t)},find:function(n){return(0,r.findOneAsync)(e,n)},list:function(n,t,u){return(0,r.listManyAsync)(e,n,t,u)},listIn:function(n,t,u,a,s){return(0,r.listManyInAsync)(e,n,t,u,a,s)},listOr:function(n,t,u,a){return(0,r.listManyOrAsync)(e,n,t,u,a)},delete:function(n){return(0,r.deleteOneAsync)(e,n)},push:function(n,t){return(0,r.pushItemsAsync)(e,n,t)},pull:function(n,t){return(0,r.pullItemsAsync)(e,n,t)}}}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.encode=function(e){return r.sign(e,u.JWT_PASSWORD)},n.verifyHeader=function(e){var n=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=e.split(" ");if(2===n.length){var t=n[0],a=n[1];if(/^Bearer$/i.test(t))return r.verify(a,u.JWT_PASSWORD)}throw new Error}(e.Authorization);return delete global.auth,global.auth=n,n};var r=function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n.default=e,n}(t(11)),u=t(12)},function(e,n){e.exports=require("jsonwebtoken")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.JWT_PASSWORD="Password1234"},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(8),u=t(9),a=r.COLLECTIONS.USER,s=(0,u.Entity)(a);n.default=s},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(8),u=t(9),a=r.COLLECTIONS.INVITE,s=(0,u.Entity)(a);n.default=s},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(8),u=t(9),a=r.COLLECTIONS.ROOM,s=(0,u.Entity)(a);n.default=s},function(e,n){e.exports=require("uuid")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(8),u=t(9),a=r.COLLECTIONS.CHAT,s=(0,u.Entity)(a);n.default=s},,,,,,,,,,,,function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.handler=void 0;var r=v(t(30)),u=v(t(0)),a=v(t(1)),s=v(t(2)),i=v(t(31)),c=function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n.default=e,n}(t(32)),o=v(t(16)),d=t(10),f=v(t(13)),l=v(t(17)),p=v(t(15)),y=v(t(14));function v(e){return e&&e.__esModule?e:{default:e}}var x,b=function(e,n,t){return new i.default((function(r,i){var c;e.postToConnection({ConnectionId:n,Data:(0,s.default)(t)},(c=(0,a.default)(u.default.mark((function e(t,a){var s;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=7;break}return e.next=3,f.default.find({connections:n});case 3:return s=e.sent,e.next=6,f.default.pull({id:s.id},{connections:n});case 6:i(t);case 7:r(a);case 8:case"end":return e.stop()}}),e,void 0)}))),function(e,n){return c.apply(this,arguments)}))}))};n.handler=(x=(0,a.default)(u.default.mark((function e(n){var t,a,v,x,m,O,A,h,w,M,I,g,_,j,k,D,P,S,C,T,B,E,q,N,L,U,R,$,W,V,G,H;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=n.requestContext,a=n.body,v=t.connectionId,x=t.domainName,m=t.stage,O=JSON.parse(a),A=O.data,e.next=6,(0,d.verifyHeader)({Authorization:A.auth_token});case 6:if(h=e.sent,"connect"!==A.type){e.next=10;break}return e.next=10,f.default.push({id:h.userId},{connections:v});case 10:if("send"!==A.type){e.next=31;break}if(w=new c.ApiGatewayManagementApi({apiVersion:"2018-11-29",endpoint:"https://"+x+"/"+m}),M={id:o.default.v4(),type:A.type,createdOn:(new Date).getTime(),senderId:A.senderId,recipientId:A.recipientId,roomId:A.roomId,message:A.message,active:!0},!A.recipientId){e.next=19;break}return e.next=16,f.default.find({id:A.recipientId});case 16:return I=e.sent,e.next=19,i.default.all(I.connections.map((function(e){return b(w,e,M)})));case 19:if(!A.roomId){e.next=29;break}return e.next=22,p.default.find({id:A.roomId});case 22:return _=e.sent,j=_.userIds,k=void 0===j?[]:j,e.next=26,f.default.listIn("id",k);case 26:return D=e.sent,e.next=29,i.default.all((g=[]).concat.apply(g,(0,r.default)(D.map((function(e){return e.connections||[]})))).filter((function(e){return e!==v})).map((function(e){return b(w,e,M)})));case 29:return e.next=31,l.default.create(M);case 31:if("invite"!==A.type){e.next=42;break}return P=new c.ApiGatewayManagementApi({apiVersion:"2018-11-29",endpoint:"https://"+x+"/"+m}),e.next=35,f.default.find({username:A.username});case 35:return S=e.sent,C=S.connections,T={id:o.default.v4(),type:A.type,createdOn:(new Date).getTime(),username:h.username,senderId:h.userId,recipientId:S.id,active:!0},e.next=40,y.default.create(T);case 40:return e.next=42,i.default.all(C.map((function(e){return b(P,e,T)})));case 42:if("accept"!==A.type){e.next=60;break}return B=new c.ApiGatewayManagementApi({apiVersion:"2018-11-29",endpoint:"https://"+x+"/"+m}),e.next=46,f.default.find({username:h.username});case 46:return E=e.sent,e.next=49,f.default.find({username:A.username});case 49:return q=e.sent,e.next=52,f.default.push({id:h.userId},{friends:q.id});case 52:return e.next=54,f.default.push({id:q.id},{friends:h.userId});case 54:return e.next=56,y.default.delete({senderId:q.id,recipientId:h.userId});case 56:return N=q.connections,L={type:A.type,friends:[q,{id:h.userId,username:h.username}]},e.next=60,i.default.all(E.connections.concat(N).map((function(e){return b(B,e,L)})));case 60:if("add-room"!==A.type){e.next=72;break}return R=new c.ApiGatewayManagementApi({apiVersion:"2018-11-29",endpoint:"https://"+x+"/"+m}),$=A.name,W=A.userIds,e.next=65,p.default.create({id:o.default.v4(),name:$,userIds:W.concat(h.userId)});case 65:return V=e.sent,e.next=68,f.default.listIn("id",W.concat(h.userId));case 68:return G=e.sent,H={type:A.type,room:V},e.next=72,i.default.all((U=[]).concat.apply(U,(0,r.default)(G.map((function(e){return e.connections||[]})))).map((function(e){return b(R,e,H)})));case 72:return e.abrupt("return",{statusCode:200,headers:{"Access-Control-Allow-Origin":"*"},body:(0,s.default)({})});case 75:return e.prev=75,e.t0=e.catch(0),console.log(e.t0),e.abrupt("return",{statusCode:500,headers:{"Access-Control-Allow-Origin":"*"},body:(0,s.default)(e.t0,["name","message"])});case 79:case"end":return e.stop()}}),e,void 0,[[0,75]])}))),function(e){return x.apply(this,arguments)})},function(e,n){e.exports=require("babel-runtime/helpers/toConsumableArray")},function(e,n){e.exports=require("babel-runtime/core-js/promise")},function(e,n){e.exports=require("aws-sdk")}]));
>>>>>>> 9ca2aa1d1c1b466e3d8dc1040e697cfa24521d14
